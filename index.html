<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <title>il2fb-game-log-parser demo</title>

  <link href='//fonts.googleapis.com/css?family=Raleway:400,300,600' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="./static/css/normalize.css">
  <link rel="stylesheet" href="./static/css/skeleton.css">
  <link rel="stylesheet" href="./static/css/custom.css">

  <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href='./static/favicon.ico' rel="shortcut icon" type="image/x-icon">
</head>
<body>

<div class="container">
  <div class="row">
    <div class="column hero">
      <h1><a href=".">il2fb-game-log-parser demo</a></h1>
      <p>
        This is a demo page of
        <a href="https://github.com/IL2HorusTeam/il2fb-game-log-parser" target="_blank">il2fb-game-log-parser</a>
        library. It is used to check library's ability to parse events log file
        produced by dedicated server of «IL-2&nbsp;Sturmovik:&nbsp;Forgotten&nbsp;Battles»
        flight simulator.
      </p>
      <p>
        <a id="supported_events_link" href="#supported_events_popup">Click to see the list of events</a>
        supported by the latest version of the library.
      </p>
    </div>
    <div class="u-cf"></div>

    <ul class="messages">
    </ul>

    <div class="row form-container">
      <form action="post">
        <label for="exampleMessage" class='u-pull-left'>
          Insert events you want to parse below:
        </label>
        <a id='clear_data_link' class='u-pull-right' href="javascript:void(0);">
          Clear
        </a>
        <a id='insert_test_data_link' class='u-pull-right' href="javascript:void(0);">
          Insert test data
        </a>
        <textarea name="stream" class="u-full-width" placeholder="[8:33:05 PM] User0:Pe-8 loaded weapons '40fab100' fuel 40%" rows="1" autofocus></textarea>
        <input class="button-primary u-full-width" value="Parse" type="submit">
      </form>
    </div>

    <div class="row results-container">
      <h3>Results</h3>
      <div class='events'></div>
    </div>

  </div>
</div>

<div id="supported_events_popup" class="white-popup mfp-hide">
  <h4>Supported events</h4>
  <ol>
  <!-- list placeholder -->
  </ol>
</div>

<div id="processing_request_popup" class="white-popup mfp-hide">
  Processing…
</div>

<a href="https://github.com/IL2HorusTeam/il2fb-game-log-parser/" class="github-corner" aria-label="View source on Github" title="View source on Github"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

<script type="text/javascript" src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.4/moment.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.16/socket.io.min.js"></script>
<script type="text/javascript" src="static/js/jquery.autosize.min.js"></script>
<script type="text/javascript" src="static/js/jquery.magnific-popup.min.js"></script>

<script type="text/javascript">
$(document).ready(function() {
  /* Patches --------------------------------------------------------------- */
  String.prototype.startsWith = function(prefix) {
    return this.indexOf(prefix) === 0;
  }
  String.prototype.endsWith = function(suffix) {
      return this.match(suffix + "$") == suffix;
  }

  /* Variables ------------------------------------------------------------- */
  var stream_input = $("textarea[name='stream']")
    , form_container = $('.form-container')
    , results_container = $('.results-container')
    , events = results_container.find('.events')
    , test_data = "";

  stream_input.autosize()

  $('#supported_events_link').magnificPopup({
      type: 'inline'
    , midClick: true
  })

  function scroll_to_element(element, delay) {
    $('html, body').animate({scrollTop: element.offset().top}, delay || 0);
  }

  $('#insert_test_data_link').on('click', function() {
    stream_input.val(test_data).trigger('autosize.resize');
  })

  $('#clear_data_link').on('click', function() {
    stream_input.val("").trigger('autosize.resize');
  })

  $('form').submit(function() {
    try {
      parse_stream();
    } catch (e) {
      console.error(e.message);
      console.log(e.stack);
    } finally {
      return false;
    }
  })

  /* Global messages --------------------------------------------------------*/
  var messages = $('ul.messages');

  function global_message(message, category) {
    var the_class = "notice";
    if (category) {
      the_class = the_class + " " + category;
    }
    messages.append($("<li>", {class: the_class, text: message}));
  }

  function global_error(message) {
    global_message(message, "error");
  }

  /* Renderers --------------------------------------------------------------*/
  function render_traceback(traceback) {
    return "<pre><code>" + traceback + "</code></pre>";
  }

  function render_event(event) {

    function render_value(value) {
      var setter = ($.type(value) === "string") ? "html" : "append";
      return $("<div>", {class: "column"})[setter](value);
    }

    function render_field(label, value) {
      return render_value(label + ": " + value);
    }

    function render_fieldset(label, fields) {
      var result = $("<fieldset>", {class: "u-full-width u-pull-left u-cf"})
                   .append($("<legend>", {text: label}));
      for (var i = 0; i < fields.length; i++) {
        result = result.append(fields[i]);
      }
      return result;
    }

    function render_actor(role, value) {
      if ($.type(value) === "string") {
        return render_field(role, value);
      } else {
        var fields = [];

        if (value.callsign !== undefined) {
          fields.push(render_field("Callsign", value.callsign));
        }
        if (value.flight !== undefined) {
          fields.push(render_field("Flight", value.flight));
        }
        if (value.aircraft !== undefined) {
          fields.push(render_field("Aircraft", value.aircraft));
        }
        if (value.id !== undefined) {
          fields.push(render_field("ID", value.id));
        }
        if (value.name !== undefined) {
          fields.push(render_field("Name", value.name));
        }
        if (value.index !== undefined) {
          fields.push(render_field("Index", value.index));
        }

        return render_fieldset(role, fields);
      }
    }

    var fields = $()
      , header = $();

    header = header.add($("<span>", {title: event.name, text: event.verbose_name}));

    if (event.time !== undefined) {
      var element = $("<span>", {class: "time u-pull-right", title: "Time"})
                    .append($("<i>", {class: "fa fa-clock-o fa-lg"}))
                    .append(event.time);
      header = header.add(element);
    }

    if (event.date !== undefined) {
      var element = $("<span>", {class: "date u-pull-right", title: "Date"})
                    .append($("<i>", {class: "fa fa-calendar fa-lg"}))
                    .append(moment(event.date).format("DD MMM, YYYY"));
      header = header.add(element);
    }

    header = render_value(header);
    fields = fields.add(header);

    if (event.mission !== undefined) {
      fields = fields.add(render_field("Mission", event.mission));
    }

    if (event.actor !== undefined) {
      fields = fields.add(render_actor("Actor", event.actor));
    }

    if (event.attacker !== undefined) {
      fields = fields.add(render_actor("Attacker", event.attacker));
    }

    if (event.assistant !== undefined) {
      fields = fields.add(render_actor("Assistant", event.assistant));
    }

    if (event.seat !== undefined) {
      fields = fields.add(render_actor("Seat", event.seat));
    }

    if (event.belligerent !== undefined) {
      fields = fields.add(render_field("Belligerent", event.belligerent.verbose_name));
    }

    if (event.index !== undefined) {
      fields = fields.add(render_field("Index", event.index));
    }

    if (event.state !== undefined) {
      fields = fields.add(render_field("State", event.state));
    }

    if (event.value !== undefined) {
      fields = fields.add(render_field("Value", event.value));
    }

    if (event.weapons !== undefined) {
      fields = fields.add(render_field("Weapons", event.weapons));
    }

    if (event.fuel !== undefined) {
      fields = fields.add(render_field("Fuel", event.fuel));
    }

    if (event.pos !== undefined) {
      fields = fields.add(render_fieldset(
        "Position",
        [
            render_field("X", event.pos.x.toFixed(2))
          , render_field("Y", event.pos.y.toFixed(2))
        ]
      ))
    }

    if (fields.length > 1) {
      header.addClass("header");
    }

    return fields.add($("<div>", {class: "u-cf"}));
  }

  function render_results(items) {
    for (var i = 0; i < items.length; i++) {
      var item = items[i]
        , row = $("<div>", {class: "row event"})
        , icon_container = $("<div>", {class: "one column"})
        , status = $("<i>", {
            class: "fa fa-lg u-pull-left parsing-status"
        })
        , show_details = $("<i>", {
            class: "fa fa-lg fa-eye u-pull-right show-details"
          , title: "Show details"
        })
        , details = $("<div>", {class: "event-details"});

      icon_container.append(status);
      icon_container.append(show_details);

      status.show();
      show_details.show();

      row.append($("<div>", {class: "one column", text: i + 1}));
      row.append($("<div>", {
          class: "ten columns string"
        , text: item.line
        , title: item.line
      }));
      row.append(icon_container);
      row.append($("<div>", {class: "u-cf"}));
      row.append(details);

      if (item.status == 'ok') {
        status.addClass('fa-check-circle success').attr('title', "Success");
        details.append(render_event(item.event));
      } else {
        status.addClass('fa-minus-circle error').attr('title', "Error");
        details.addClass('error');
        details.append($("<p>", {text: "Event was not parsed"}));
        details.append($(render_traceback(item.traceback)));
      }

      show_details.on('click', function() {
        var details = $(this).closest('div.event').find('div.event-details');

        if ($(this).hasClass('fa-eye')){
          $(this).attr("title", "Hide details");
          details.show();
        } else {
          $(this).attr("title", "Show details");
          details.hide();
        }

        $(this).toggleClass('fa-eye fa-eye-slash');
      });

      events.append(row);
    }
  }

  /* API IO -----------------------------------------------------------------*/
  var API_URL_BASE = "https://europe-west1-il2-horus-demo-services.cloudfunctions.net"
  // var API_URL_BASE = "http://127.0.0.1:5000"

  function parse_stream() {
    $('.hero p').remove();
    messages.empty();
    messages.hide();

    events.empty();
    results_container.hide();

    var strings = stream_input
                  .val()
                  .split('\n')
                  .map($.trim)
                  .filter(function (x) {return x && x.length > 0});

    if (strings.length == 0) {
      messages.show();
      global_error("Input data is empty. Please, insert events to parse");
      return false;
    }

    form_container.hide();

    $.magnificPopup.open({
      items: {
        src: '#processing_request_popup',
        type: 'inline'
      }
      , modal: true
      , cursor: 'mfp-ajax-cur'
    });

    $.ajax({
      url: API_URL_BASE + "/events-parse",
      type: "POST",
      data: JSON.stringify(strings),
      dataType: "json",
      contentType: "application/json;charset=utf-8",
      success: function(data) {
        results_container.show();
        render_results(data.data);
      },
      complete: function(jqXhr, textStatus) {
        form_container.show();
        $.magnificPopup.close();
        scroll_to_element(results_container);
      }
    })

    return false;
  }

  /* Load initial data ------------------------------------------------------*/
  $.magnificPopup.open({
    items: {
      src: API_URL_BASE + "/events-parser-data"
    }
    , type: 'ajax'
    , modal: true
    , cursor: 'mfp-ajax-cur'
    , callbacks: {
      parseAjax: function(response) {
        test_data = "";
        result = response.data;

        var ol = $('div#supported_events_popup>ol');
        for (var i = 0; i < result.supported_events.length; i++) {
            // Insert info about event into popup
            var data = result.supported_events[i]
              , name = data[0]
              , description = data[1];

            ol.append($("<li>", {text: name, title: description}));

            // Update test data
            examples = description.split('\n');
            for (var j = 0; j < examples.length; j++) {
              var s = examples[j];
              if (s.startsWith('"') && s.endsWith('"')) {
                s = s.slice(1, s.length - 1);
                test_data += (i > 0) ? "\n" + s : s;
              }
            }
        }
        $.magnificPopup.close();
      }
    }
  });

})
</script>

</body>
</html>

<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
<link rel="stylesheet" href="static/css/magnific-popup.css">
